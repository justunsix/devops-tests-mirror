# -*- mode: ruby -*-
# vi: set ft=ruby :

# Vagrantfile provisioners based on https://bbs.archlinux.org/viewtopic.php?id=260017 created by gwpl
# with additions from https://github.com/balingit/vagrant-archlinux-gui
#
# Changes made:
# - Added Virtualbox clipboard and drag, drop sharing
# - Additional comments on script steps
# - Set localisation per https://wiki.archlinux.org/title/locale
# - Add sound configuration

Vagrant.configure("2") do |config|

  config.vm.box = "archlinux/archlinux"

  ############################################################
  # Copy some host files to configure VM like the host
  ############################################################

  # Starsip config for prompt
  if File.exists?(File.expand_path("#{ENV['HOME']}/.config/starship.toml"))
    config.vm.provision "file", source: "#{ENV['HOME']}/.config/starship.toml", destination: ".config/starship.toml"
  end

  # nushell config from a dotfiles repo for shell
  if File.exists?(File.expand_path("#{ENV['HOME']}/Code/dotfiles/.config/nushell"))
    config.vm.provision "file", source: "#{ENV['HOME']}/Code/dotfiles/.config/nushell", destination: ".config/nushell"
  end

  # fish config for shell
  if File.exists?(File.expand_path("#{ENV['HOME']}/.config/fish/config.fish"))
    config.vm.provision "file", source: "#{ENV['HOME']}/.config/fish/config.fish", destination: ".config/fish/config.fish"
  end

  ############################################################
  # VirtualBox Hypervisor Configuration
  ############################################################

  config.vm.provider "virtualbox" do |vb|
    # https://www.vagrantup.com/docs/providers/virtualbox/configuration
    vb.gui = true
    vb.name = "Archlinux_GUI"
    vb.linked_clone = true
    vb.check_guest_additions = true
    # v.customize ["modifyvm", :id, "--cpuexecutioncap", "50"]
    # Video ram in MB, increase to 128 and increase memory to 4096 for more graphical applications like browser
    vb.customize ["modifyvm", :id, "--vram", "64"] 
    vb.memory = 2048
    vb.cpus = 2
    # Enable bidirectional clipboard sharing
    vb.customize ["modifyvm", :id, "--clipboard-mode", "bidirectional"]
    # Enable bidirectional drag and drop
    vb.customize ["modifyvm", :id, "--draganddrop", "bidirectional"]    
    # Enable audio 
    # - dsound for Windows DirectSound, alsa for Linux, or coreaudio for macOS
    vb.customize ["modifyvm", :id, "--audio", "dsound"]
    vb.customize ["modifyvm", :id, "--audiocontroller", "hda"]
    
  end

  ############################################################
  # Provisioners
  ############################################################

  config.vm.provision "main-setup", type: "shell", run: "never", path: "provisioner/main-setup.sh"

  config.vm.provision "xorg", type: "shell", run: "never", path: "provisioner/xorg.sh"

  config.vm.provision "kde", type: "shell", run: "never", path: "provisioner/desktop-kde.sh"

  config.vm.provision "gnome", type: "shell", run: "never", path: "provisioner/desktop-gnome.sh"

  config.vm.provision "sound", type: "shell", run: "never", path: "provisioner/sound.sh"

  config.vm.provision "nix", type: "shell", run: "never", path: "provisioner/nix.sh"

  config.vm.provision "nix-home-manager", type: "shell", run: "never", privileged: false, path: "provisioner/nix-home-manager.sh"

end